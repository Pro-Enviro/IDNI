<div class="flex">
  <div class="flex-1">
    <p-panel header="Select Company">
      <p-selectButton [options]="companies" [(ngModel)]="selectedCompany" optionLabel="name" optionValue="id" (ngModelChange)="onSelectCompany()" class="btn-select"></p-selectButton>
    </p-panel>
  </div>
  <div class="flex-1" *ngIf="mpan.length">
    <p-panel header="Select Mpan">
      <p-selectButton [options]="mpan" [(ngModel)]="selectedMpan" (ngModelChange)="onSelectCompany()" class="btn-select"></p-selectButton>
    </p-panel>
  </div>
</div>

<p-panel>


  <p-selectButton
    *ngIf="fieldFilters"
    [options]="fieldFilters"
    [(ngModel)]="filteredField"
    (ngModelChange)="splitByMonth(data)"
    class="btn-select"
  ></p-selectButton>

  <p-selectButton  [options]="defaultFilters" [(ngModel)]="dateFilter" optionLabel="name" optionValue="value" (ngModelChange)="filterData()" class="btn-select" [style]="{marginTop: '1rem'}"></p-selectButton>
  <div echarts [options]="chartOptions" style="max-height: 60vh; height: 600px; margin-top: 3rem"></div>

</p-panel>

<p-panel header="Totals">
  <div class="flex justify-content-end m-3">
    <button pButton class="btn-dark" pRipple icon="pi pi-file-excel" (click)="exportExcel()"></button>
  </div>
  <p-table [value]="typeTotals" styleClass="p-datatable-sm">
    <ng-template pTemplate="header">
      <tr>
        <th>Utility</th>
        <th>Consumption (kWh)</th>
        <th>Consumption %</th>
        <th>Cost £</th>
        <th>Cost %</th>
        <th>Carbon Emissions KG CO2e</th>
        <th>Carbon Emissions %</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-typeTotals let-i="rowIndex">
      <tr>
        <td>{{typeTotals.type}}</td>
        <td>{{(typeTotals.consumption).toLocaleString('en-US', strOptions)}} <span style="font-size: 0.9rem; color: #7e7c7c">{{typeTotals.converted ? ' (Converted to kWh)' : ''}}</span></td>
        <td>{{((typeTotals.consumption / totalConsumption) * 100).toFixed(2)}}</td>
        <td>{{typeTotals.cost.toLocaleString('en-US', strOptions)}}</td>
        <td>{{((typeTotals?.cost / totalCost) * 100).toFixed(2)}}</td>
        <td >{{(typeTotals.consumption * typeTotals.conversionFactor).toLocaleString('en-US', strOptions) }}</td>
        <td>{{(((typeTotals.consumption * typeTotals.conversionFactor) / totalEmissions)*100 ).toFixed(2)}}</td>
      </tr>
    </ng-template>

    <ng-template pTemplate="footer">
      <tr>
        <td colspan="1">Totals</td>
        <td>{{(totalConsumption).toLocaleString('en-US', strOptions)}} kWh</td>
        <td colspan="1"></td>
        <td>£{{totalCost.toLocaleString('en-US', strOptions)}}</td>
        <td colspan="1"></td>
        <td>{{totalEmissions.toLocaleString('en-US', strOptions)}}</td>
        <td colspan="1"></td>
      </tr>
    </ng-template>

  </p-table>
</p-panel>
